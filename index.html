<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Steven P. Sanderson II, MPH">
<meta name="dcterms.date" content="2025-10-24">

<title>Practice Work With Ollama in Python and R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-dd69d3d26763a1884eb60582decffdb7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#is-ollama-installed-for-python" id="toc-is-ollama-installed-for-python" class="nav-link" data-scroll-target="#is-ollama-installed-for-python">Is ollama installed for python?</a></li>
  <li><a href="#simple-call-to-ollama" id="toc-simple-call-to-ollama" class="nav-link" data-scroll-target="#simple-call-to-ollama">Simple Call to Ollama</a>
  <ul class="collapse">
  <li><a href="#python" id="toc-python" class="nav-link" data-scroll-target="#python">Python</a></li>
  <li><a href="#r" id="toc-r" class="nav-link" data-scroll-target="#r">R</a></li>
  </ul></li>
  <li><a href="#streaming" id="toc-streaming" class="nav-link" data-scroll-target="#streaming">Streaming</a>
  <ul class="collapse">
  <li><a href="#r-1" id="toc-r-1" class="nav-link" data-scroll-target="#r-1">R</a></li>
  </ul></li>
  <li><a href="#the-generate-endpoint" id="toc-the-generate-endpoint" class="nav-link" data-scroll-target="#the-generate-endpoint">The Generate Endpoint</a></li>
  <li><a href="#using-a-modelfile" id="toc-using-a-modelfile" class="nav-link" data-scroll-target="#using-a-modelfile">Using a MODELFILE</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Practice Work With Ollama in Python and R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Steven P. Sanderson II, MPH </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">py_require</span>(<span class="st">"ollama"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This is where I am going to learn how to use ollama with Python and R.</p>
</section>
<section id="is-ollama-installed-for-python" class="level1">
<h1>Is ollama installed for python?</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib.util</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>module_name <span class="op">=</span> <span class="st">"ollama"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> importlib.util.find_spec(module_name):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>module_name<span class="sc">}</span><span class="ss"> is installed."</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>module_name<span class="sc">}</span><span class="ss"> is not installed."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ollama is installed.</code></pre>
</div>
</div>
</section>
<section id="simple-call-to-ollama" class="level1">
<h1>Simple Call to Ollama</h1>
<p>Let’s make a simple request using python to get a response to a simple question:</p>
<section id="python" class="level2">
<h2 class="anchored" data-anchor-id="python">Python</h2>
<p>First in python.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ollama</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> ollama.<span class="bu">list</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> ollama.chat(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: <span class="st">"Write a haiku about Ollama and Deepseek"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>model='deepseek-v3.1:671b-cloud' created_at='2025-10-24T12:43:48.34416985Z' done=True done_reason='stop' total_duration=1089134133 load_duration=None prompt_eval_count=14 prompt_eval_duration=None eval_count=22 eval_duration=None message=Message(role='assistant', content="Silent code takes flight,\nDeepseek's wisdom fills the mind,\nNew paths glow with light.", thinking=None, images=None, tool_name=None, tool_calls=None)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res[<span class="st">"message"</span>][<span class="st">"content"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Silent code takes flight,
Deepseek's wisdom fills the mind,
New paths glow with light.</code></pre>
</div>
</div>
</section>
<section id="r" class="level2">
<h2 class="anchored" data-anchor-id="r">R</h2>
<p>Now let’s do the same but with R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ollamar)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_connection</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;httr2_response&gt;
GET http://localhost:11434/
Status: 200 OK
Content-Type: text/plain
Body: In memory (17 bytes)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>arg_list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">prompt =</span> <span class="st">"Write a haiku about Ollama and Deepseek."</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>response <span class="ot">=</span> <span class="fu">do.call</span>(generate, arg_list)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;httr2_response&gt;
POST http://127.0.0.1:11434/api/generate
Status: 200 OK
Content-Type: text/plain
Body: In memory (347 bytes)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resp_process</span>(response, <span class="st">"text"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Code whispers low,\nDeepseek's mind in Ollama's soul,\nSilent answers grow."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resp_process</span>(response, <span class="st">"df"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  model                    response                                   created_at
  &lt;chr&gt;                    &lt;chr&gt;                                      &lt;chr&gt;     
1 deepseek-v3.1:671b-cloud "Code whispers low,\nDeepseek's mind in O… 2025-10-2…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Or specify output type</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>txt <span class="ot">&lt;-</span> <span class="fu">do.call</span>(generate, <span class="fu">c</span>(arg_list, <span class="at">output =</span> <span class="st">"text"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "A quiet query,\nDeepseek's thought in Ollama's heart—\nWisdom blooms in code."</code></pre>
</div>
</div>
</section>
</section>
<section id="streaming" class="level1">
<h1>Streaming</h1>
<p>First in Pyhon</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> ollama.<span class="bu">list</span>()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> ollama.chat(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: <span class="st">"Why is the ocean so salty?"</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    stream<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chunk <span class="kw">in</span> res:</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(chunk[<span class="st">"message"</span>][<span class="st">"content"</span>], end<span class="op">=</span><span class="st">""</span>, flush <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Of course! This is a fantastic question with a fascinating answer that involves billions of years of Earth's history.

The short answer is: **The ocean is salty because rivers and streams have been washing dissolved salts from rocks and soil into it for billions of years.**

The long answer explains why it *stays* salty and how that process works. Here’s a step-by-step breakdown:

### 1. The Source of the Salt: Weathering Rocks

The primary process is called **rock weathering**.
*   Rainwater is slightly acidic. As it falls through the atmosphere, it absorbs carbon dioxide, forming a weak carbonic acid.
*   This acidic rain falls on rocks on land, slowly eroding them.
*   This erosion breaks down the rocks and releases minerals and salts, including ions like **sodium (Na⁺)** and **chloride (Cl⁻)**—the two components of table salt—as well as others like potassium, calcium, and sulfate.
*   These dissolved ions are carried by rivers and streams all the way to the ocean.

This process has been happening continuously for over 4 billion years, since the Earth's first oceans formed.

### 2. Why the Ocean Gets Salty, But Rivers Don't

This is the key part of the puzzle. Rivers carry very tiny amounts of these dissolved salts—so little that we taste them as "fresh" water. So why does the ocean become salty?

*   **The Role of Evaporation:** When ocean water evaporates, it's only the pure **water (H₂O)** that turns into vapor and rises to form clouds. The dissolved salts are left behind in the ocean.
*   **A One-Way Trip:** The water cycle constantly replenishes the ocean with fresh water from rain and rivers, which again brings more salts. But the salts themselves have no easy way to leave. This is a one-way transport system: salts go in, but they don't come out.

Over millions of years, this continuous input of salts with no equivalent output has led to a gradual buildup, making the ocean salty.

### 3. Where *Do* the Salts Go? (A Little Bit Does Leave)

While the system is overwhelmingly weighted toward salt accumulation, tiny amounts of salt are removed, which prevents the ocean from becoming infinitely saltier. Salts are removed through processes like:
*   **Sea Spray:** Wind blows tiny droplets of seawater inland, depositing a minuscule amount of salt on land.
*   **Absorption:** Elements are absorbed by marine organisms. For example, clams and corals use calcium to build their shells and skeletons.
*   **Hydrothermal Vents:** At mid-ocean ridges, seawater seeps into the ocean floor, gets heated by magma, and leaches minerals out of the rock before spewing back out. This process removes some elements.
*   **Sedimentation:** Some salts settle onto the seafloor and become buried in sediment layers.

These removal processes roughly balance the input *now*, which is why the ocean's salinity has been relatively stable for a very long time.

---

### A Quick Note on the "Salty" Taste

While the ocean contains many dissolved minerals, the reason it *tastes* like table salt is that about **90%** of all the dissolved ions in seawater are **sodium (Na⁺)** and **chloride (Cl⁻)**, the very same ingredients.

### In a Nutshell:

The ocean is salty because it acts as the **final destination for minerals washed off the land**. The water evaporates and cycles back to the land as rain, but the salts are left behind, accumulating over geologic time. It's a natural concentrating effect that has been running for billions of years.</code></pre>
</div>
</div>
<section id="r-1" class="level2">
<h2 class="anchored" data-anchor-id="r-1">R</h2>
<p>Now in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>messages <span class="ot">&lt;-</span> <span class="fu">create_message</span>(<span class="st">"Why is the ocean so salty?"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>arg_list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">messages =</span> messages,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">stream =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="st">"text"</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>txt <span class="ot">&lt;-</span> <span class="fu">do.call</span>(chat, arg_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Of course! This is a fantastic question with a fascinating answer that involves geology, chemistry, and hundreds of millions of years.

The short answer is: **The ocean is salty because of a slow, continuous process where rainwater dissolves minerals from rocks on land, and rivers carry those minerals (salts) to the ocean.**

Here’s a more detailed breakdown of how it works:

### 1. The Source of the Salt: Weathering of Rocks

It all starts on land with a process called **chemical weathering**.

*   **Rainwater is slightly acidic:** Even pure rainwater is not entirely neutral. It absorbs carbon dioxide (CO₂) from the air, forming a weak acid called carbonic acid (H₂CO₃).
*   **Acid attacks rocks:** When this slightly acidic rain falls on rocks, it slowly erodes and dissolves them. Rocks contain various soluble minerals and ions, most notably **Sodium (Na⁺)** and **Chloride (Cl⁻)**, which are the two ions that make up ordinary table salt (NaCl). Other ions like calcium, potassium, and sulfate are also dissolved.
*   **Rivers are the transporters:** These dissolved ions are carried by streams and rivers all the way to the ocean. This process has been happening for billions of years.

### 2. The Ocean as a "Collecting Bowl"

Once the salts enter the ocean, they stay there.

*   **Water evaporates, salt stays behind:** The sun heats the ocean, causing water to evaporate. However, when water evaporates, it leaves the dissolved salts behind. The pure water vapor forms clouds, which eventually lead to rain that falls back on land, and the cycle continues.
*   **This is a one-way trip for salt:** The salts have no easy way to leave the ocean in large quantities. This makes the ocean a giant, long-term collecting bowl for salts. Over hundreds of millions of years, this slow, steady input of salt has built up to the concentration we see today.

### Why Doesn't the Ocean Keep Getting Saltier?

You might wonder, if rivers keep bringing salt, why isn't the ocean unbearably salty? The saltiness (salinity) of the ocean has been roughly stable for a very long time because **input and output are in balance**.

While salt is constantly being added, it's also being removed in several ways:

1.  **Sea Spray:** Ocean waves crashing onto the shore release salty spray into the air, which can be carried inland.
2.  **Biological Processes:** Marine organisms use the dissolved ions. For example, clams and corals use calcium to build their shells and skeletons. When they die, these shells can sink to the bottom and eventually form limestone, trapping the minerals for a very long time.
3.  **Hydrothermal Vents:** At mid-ocean ridges, seawater seeps into the hot oceanic crust, gets heated, and dissolves minerals from the rock. When it vents back into the ocean, some minerals precipitate out and are deposited on the seafloor.
4.  **Evaporite Deposits:** In shallow, enclosed seas (like the Dead Sea or the ancient Mediterranean Sea), high evaporation rates can cause the water to become so salty that the minerals actually crystallize and settle on the bottom as layers of salt, gypsum, and other minerals.

### A Few Interesting Extra Facts

*   **The Salinity is Remarkably Consistent:** The average salinity of the ocean is about **35 parts per thousand** (ppt), meaning about 3.5% of the weight of seawater comes from dissolved salts. This ratio is surprisingly constant across most of the world's oceans, though it can be lower near rivers or poles (from melting ice) and higher in areas with high evaporation, like the Red Sea.
*   **It's Not Just Table Salt:** While sodium and chloride make up about 85% of the dissolved ions, seawater is a complex "soup" of almost every natural element.
*   **The Salt on Your Table:** Most of the table salt we use today comes from ancient evaporite deposits—places where ancient oceans dried up long ago, leaving massive salt beds behind.

### In a Nutshell:

Think of it as a very slow, planet-sized recipe. **Land rocks are the source, rivers are the delivery system, and the ocean is the giant pot where the "salt soup" has been simmering for billions of years.** The water evaporates and is replenished by rain, but the salt concentrates over time, leading to the salty oceans we have today.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Of course! This is a fantastic question with a fascinating answer that involves geology, chemistry, and hundreds of millions of years.\n\nThe short answer is: **The ocean is salty because of a slow, continuous process where rainwater dissolves minerals from rocks on land, and rivers carry those minerals (salts) to the ocean.**\n\nHere’s a more detailed breakdown of how it works:\n\n### 1. The Source of the Salt: Weathering of Rocks\n\nIt all starts on land with a process called **chemical weathering**.\n\n*   **Rainwater is slightly acidic:** Even pure rainwater is not entirely neutral. It absorbs carbon dioxide (CO₂) from the air, forming a weak acid called carbonic acid (H₂CO₃).\n*   **Acid attacks rocks:** When this slightly acidic rain falls on rocks, it slowly erodes and dissolves them. Rocks contain various soluble minerals and ions, most notably **Sodium (Na⁺)** and **Chloride (Cl⁻)**, which are the two ions that make up ordinary table salt (NaCl). Other ions like calcium, potassium, and sulfate are also dissolved.\n*   **Rivers are the transporters:** These dissolved ions are carried by streams and rivers all the way to the ocean. This process has been happening for billions of years.\n\n### 2. The Ocean as a \"Collecting Bowl\"\n\nOnce the salts enter the ocean, they stay there.\n\n*   **Water evaporates, salt stays behind:** The sun heats the ocean, causing water to evaporate. However, when water evaporates, it leaves the dissolved salts behind. The pure water vapor forms clouds, which eventually lead to rain that falls back on land, and the cycle continues.\n*   **This is a one-way trip for salt:** The salts have no easy way to leave the ocean in large quantities. This makes the ocean a giant, long-term collecting bowl for salts. Over hundreds of millions of years, this slow, steady input of salt has built up to the concentration we see today.\n\n### Why Doesn't the Ocean Keep Getting Saltier?\n\nYou might wonder, if rivers keep bringing salt, why isn't the ocean unbearably salty? The saltiness (salinity) of the ocean has been roughly stable for a very long time because **input and output are in balance**.\n\nWhile salt is constantly being added, it's also being removed in several ways:\n\n1.  **Sea Spray:** Ocean waves crashing onto the shore release salty spray into the air, which can be carried inland.\n2.  **Biological Processes:** Marine organisms use the dissolved ions. For example, clams and corals use calcium to build their shells and skeletons. When they die, these shells can sink to the bottom and eventually form limestone, trapping the minerals for a very long time.\n3.  **Hydrothermal Vents:** At mid-ocean ridges, seawater seeps into the hot oceanic crust, gets heated, and dissolves minerals from the rock. When it vents back into the ocean, some minerals precipitate out and are deposited on the seafloor.\n4.  **Evaporite Deposits:** In shallow, enclosed seas (like the Dead Sea or the ancient Mediterranean Sea), high evaporation rates can cause the water to become so salty that the minerals actually crystallize and settle on the bottom as layers of salt, gypsum, and other minerals.\n\n### A Few Interesting Extra Facts\n\n*   **The Salinity is Remarkably Consistent:** The average salinity of the ocean is about **35 parts per thousand** (ppt), meaning about 3.5% of the weight of seawater comes from dissolved salts. This ratio is surprisingly constant across most of the world's oceans, though it can be lower near rivers or poles (from melting ice) and higher in areas with high evaporation, like the Red Sea.\n*   **It's Not Just Table Salt:** While sodium and chloride make up about 85% of the dissolved ions, seawater is a complex \"soup\" of almost every natural element.\n*   **The Salt on Your Table:** Most of the table salt we use today comes from ancient evaporite deposits—places where ancient oceans dried up long ago, leaving massive salt beds behind.\n\n### In a Nutshell:\n\nThink of it as a very slow, planet-sized recipe. **Land rocks are the source, rivers are the delivery system, and the ocean is the giant pot where the \"salt soup\" has been simmering for billions of years.** The water evaporates and is replenished by rain, but the salt concentrates over time, leading to the salty oceans we have today."</code></pre>
</div>
</div>
</section>
</section>
<section id="the-generate-endpoint" class="level1">
<h1>The Generate Endpoint</h1>
<p>Now let’s see how using generate changes things.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> ollama.generate(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="st">"Why is the sky blue?"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># show</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ollama.show(<span class="st">"deepseek-v3.1:671b-cloud"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>modified_at=datetime.datetime(2025, 10, 14, 14, 38, 21, 791074, tzinfo=TzInfo(-14400)) template='{{ .Prompt }}' modelfile='# Modelfile generated by "ollama show"\n# To build a new Modelfile based on this, replace FROM with:\n# FROM deepseek-v3.1:671b-cloud\n\nFROM \nTEMPLATE {{ .Prompt }}\n' license=None details=ModelDetails(parent_model='', format='', family='deepseek2', families=['deepseek2'], parameter_size='671.0B', quantization_level='FP8_E4M3') modelinfo={'deepseek2.context_length': 163840, 'deepseek2.embedding_length': 7168, 'general.architecture': 'deepseek2', 'general.basename': 'deepseek-v3.1:671b'} parameters=None capabilities=['completion', 'tools', 'thinking']</code></pre>
</div>
</div>
<p>Now in R</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>messages <span class="ot">&lt;-</span> <span class="fu">create_message</span>(<span class="st">"Why is the ocean so salty? Be concise."</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>arg_list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"deepseek-v3.1:671b-cloud"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">messages =</span> messages,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">stream =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="st">"text"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>txt <span class="ot">&lt;-</span> <span class="fu">do.call</span>(chat, arg_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The ocean is salty because of two main processes:

1.  **Runoff from Land:** Rainwater, which is slightly acidic, erodes rocks on land, dissolving salts and minerals. These ions (like sodium and chloride) are carried by rivers into the ocean.
2.  **Hydrothermal Vents:** On the seafloor, seawater seeps into cracks, gets heated by magma, and dissolves minerals from the Earth's crust before spewing back into the ocean.

Salt concentrates in the ocean because while water evaporates and falls as rain (replenishing the ocean), the dissolved salts remain behind. This has been happening for billions of years.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">show</span>(<span class="st">"deepseek-v3.1:671b-cloud"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$modelfile
[1] "# Modelfile generated by \"ollama show\"\n# To build a new Modelfile based on this, replace FROM with:\n# FROM deepseek-v3.1:671b-cloud\n\nFROM \nTEMPLATE {{ .Prompt }}\n"

$template
[1] "{{ .Prompt }}"

$details
$details$parent_model
[1] ""

$details$format
[1] ""

$details$family
[1] "deepseek2"

$details$families
$details$families[[1]]
[1] "deepseek2"


$details$parameter_size
[1] "671.0B"

$details$quantization_level
[1] "FP8_E4M3"


$remote_model
[1] "deepseek-v3.1:671b"

$remote_host
[1] "https://ollama.com:443"

$model_info
$model_info$deepseek2.context_length
[1] 163840

$model_info$deepseek2.embedding_length
[1] 7168

$model_info$general.architecture
[1] "deepseek2"

$model_info$general.basename
[1] "deepseek-v3.1:671b"


$capabilities
$capabilities[[1]]
[1] "completion"

$capabilities[[2]]
[1] "tools"

$capabilities[[3]]
[1] "thinking"


$modified_at
[1] "2025-10-14T14:38:21.791074-04:00"</code></pre>
</div>
</div>
</section>
<section id="using-a-modelfile" class="level1">
<h1>Using a MODELFILE</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following use of modelfile in the python library ollama.create does not work.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>modelfile <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM gpt-oss:20b-cloud</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="st">SYSTEM You are a very smart assistant who knows everything about the oceans. You are very sussinct and informative.</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="st">PARAMETER temperature 0.1</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>ollama.create(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">"knowitall"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    from_ <span class="op">=</span> <span class="st">"qwen3:0.6b"</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    system <span class="op">=</span> <span class="st">"You are a very smart assitant who knows everyting about the oceans. You are very sussinct and informative."</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temperature"</span>: <span class="fl">0.1</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ProgressResponse(status='success', completed=None, total=None, digest=None)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> ollama.generate(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">"knowitall"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="st">"Why is the ocean so salty?"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span> <span class="op">=</span> <span class="st">"json"</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res[<span class="st">"response"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{


}</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>